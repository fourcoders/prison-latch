<html>
<head>
	<meta charset="UTF-8">
	<title>Prison Latch</title>
	<link href='//fonts.googleapis.com/css?family=Slabo+27px' rel='stylesheet' type='text/css'>
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
	<style>
	
	body,html{
		height: 100%;
		min-height: 100%;
		margin: 0;
		padding: 0;
	}
	body{
		cursor: default;
		font-family: "Slabo 27px",sans-serif;
		background-image: -ms-linear-gradient(top, #23A4AD 0%, #0075AB 100%);
		background-image: -moz-linear-gradient(top, #23A4AD 0%, #0075AB 100%);
		background-image: -o-linear-gradient(top, #23A4AD 0%, #0075AB 100%);
		background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0, #3A4AD), color-stop(1, #0075AB));
		background-image: -webkit-linear-gradient(top, #23A4AD 0%, #0075AB 100%);
		background-image: linear-gradient(to bottom, #23A4AD 0%, #0075AB 100%);
		background-attachment: fixed;
	}
	.hide{
		display: none!important;
	}
	#welcome{
		width: 700px;
		height: 600px;
		margin:40px auto 0;
		background-color: rgba(0,0,0,.3);
		text-align: center;
	}
		#welcome img{
			margin: 40px 0;
		}
		#welcome span{
			display: block;
			font-size: 40px;
			color: #ddd;
			text-shadow: 1px 1px 2px rgba(0,0,0,.5);
			font-weight: bold;
		}
		#start{
			width: 300px;
			padding: 20px 0;
			text-align: center;
			margin: 40px auto 0;
			font-size: 40px;
			color: #fff;
			text-shadow: 1px 1px 2px rgba(0,0,0,.5);
			font-weight: bold;
			background-color: rgba(0,0,0,.2);
			cursor: pointer;
		}
		#start:hover{
			background-color: rgba(0,0,0,.4);
		}

	#game{

	}	
		#rail{
			position: absolute;
			width: 100%;
			background: red;
			height: 200px;
		}
			.room{
				z-index: 1000;
				width: 150px;
				height: 240px;
				background-size: contain;
				background-position: center top;
				background-repeat: no-repeat;
				background-size: cover;
				position: absolute;
				top: 30px;
				background-image:url("images/pared.jpg");
				z-index: 0;
				opacity:.6;
				box-shadow:  0 0 4px rgba(0,0,0,.4);
			}
				.room.pos0{
					left: 5%;
				}			
				.room.pos1{
					background-image:url("images/rejas.png");
					z-index: 1000;
					left: 5%;
				}
				.room.pos2{
					left: 20%;
				}
				.room.pos3{
					left: 35%;
				}
				.room.pos4{
					left: 50%;
				}
				.room.pos5{
					left: 65%;
				}
				.room.pos6{
					left: 80%;

					background-image:url("images/exit.jpg");
					background-size: contain;
					background-color: #fff;
					z-index: 1000;
				}
			#player{
				background-image:url("images/chema2.png");
				z-index: 500;
				width: 150px;
				height: 200px;
				background-size: contain;
				background-position: center top;
				background-repeat: no-repeat;
				position: absolute;
				top: 30px;
				left: 5%;
				-moz-transition: .3s;
				-webkit-transition: .3s;
				transition: .3s;
			}
			#player[data-pos="0"]{left:5%;}
			#player[data-pos="1"]{left:20%;}
			#player[data-pos="2"]{left:35%;}
			#player[data-pos="3"]{left:50%;}
			#player[data-pos="4"]{left:65%;}
			#player[data-pos="5"]{left:80%;}
			#lifes{
				margin-top: 200px;
				text-align: center;
			}
				.life{
					width: 30px;
					height: 30px;
					background-image:url("images/foca2.png");
					background-size: contain;
					background-position: center top;
					background-repeat: no-repeat;
					float: left;
					-moz-transition: 1s;
					-webkit-transition: 1s;
					transition: 1s;
				}
				.life.disabled{
					opacity: 0;
					-moz-transform : scale(2);
					-webkit-transform : scale(2);
					transform : scale(2);
				}

		#questions{
			width: 900px;
			margin:0 auto;
			padding-top:320px;

		}
			.question{
				width: 360px;
				margin:0 20px 40px 20px;
				padding: 0 20px;
				background-color: rgba(0,0,0,.3);
				font-size: 20px;
				color: #fff;
				text-shadow: 1px 1px 2px rgba(0,0,0,.5);
				text-align: center;
				float: left;
			}
				.circle{
					height: 20px;
					padding-right: 20px;
					margin-right: -20px;
					background-color: #fc0;
					text-align: left;
				}
					.circle i{
						font-size:50px;

						background-color: #fc0;
						box-shadow: 0 0 5px rgba(0,0,0,.4);
						width: 50px;
						height: 50px;
						text-align: center;
						border-radius: 50px;
						margin: -15px 0 0 -25px;
					}
				.question.green .circle,.question.green .circle i{ background-color: #419641 }
				.question.red .circle,.question.red .circle i{ background-color: #c12e2a}
				.question.blue .circle,.question.blue .circle i{ background-color: #5DD0F7}
				.question.yellow .circle,.question.yellow .circle i{ background-color: #eb9316}

		#check{
			width: 400px;
			padding: 20px 0;
			text-align: center;
			margin: 20px auto 0;
			font-size: 40px;
			color: #fff;
			text-shadow: 1px 1px 2px rgba(0,0,0,.5);
			font-weight: bold;
			background-color: rgba(0,0,0,.2);
			cursor: pointer;
			margin-bottom: 20px;
		}
		#check:hover{
			background-color: rgba(0,0,0,.4);
		}
		#check.disabled{
			opacity: .6;
		}
		.clear:after {
			content:"";
			display:table;
			clear:both;
		}

		#flash-message {
		    pointer-events: none;
		    position: fixed;
		    text-align: center;
		    top: 66px;
		    width: 100%;
		    z-index: 10000;
		}

		#flash-message .alert {
		  line-height: 40px;
		  padding: 25px;
		  box-shadow: 0 0 9px rgba(0, 0, 0, 0.4);
		  display: inline-block;
		  min-width: 40%;
		  opacity: .9;
		  font-size: 30px;
		}
		#flash-message .fa {
		  font-size: 40px;
		  float: left;
		  margin-right: 20px;
		}
		.alert-success {
		    background-color: #00bc8c;
		    border-color: #00bc8c;
		    color: #ffffff;
		}
		.alert {
		    border: 1px solid transparent;
		    border-radius: 4px;
		    margin-bottom: 21px;
		    padding: 15px;
		}
		.alert-danger {
		    background-color: #e74c3c;
		    border-color: #e74c3c;
		    color: #ffffff;
		}

		#open_help{
			width: 200px;
			text-align: center;
			margin: 20px auto 50px;
			color: #fff;
			cursor: pointer;
			font-family: sans-serif;
		}
		#close_help{
			background-color: #711717;
			box-shadow: 0 0 5px rgba(0,0,0,.4);
			width: 50px;
			height: 50px;
			text-align: center;
			border-radius: 50px;
			margin: -15px 0 0 -25px;
			float: left;
			font-size: 50px;
			position: absolute;
			margin-top: -90px;
			cursor: pointer;
		}
		#help {
			width: 700px;
			height: 600px;
			margin:40px auto 0;
			background-color: rgba(0,0,0,.3);
			text-align: left;
			padding: 100px 40px 40px 40px;
			color: #fff;
			font-size: 20px;
		}
	</style>
</head>
<body>
<div id="flash-message" class="hide">
	<div id="alert-ok" class="hide alert alert-success">
	    <i class="fa fa-exclamation"></i>
	   	<span>asdfasd</span>
	</div>  
	<div id="alert-ko" class="hide alert alert-danger">
	    <i class="fa fa-warning"></i>
	    <span>sdafsd fas d</span>
	</div>  
</div>

<div id="welcome">
	<img src="images/chema2.png" height="300">
	<span>¡Ayuda a Chema a salir de la cárcel!</span>
	<div id="start">EMPEZAR</div>
</div>
<div id="help" class="hide">
	<div id="close_help"><i class="fa fa-times"></i></div>
	<img width="400" src="/images/latch_help.png">
	El funcionamiento del juego es <br> muy simple, utiliza tu app de Latch para contestar al juego, si bloqueas la operación tu respuesta será un NO a esa pregunta , por el contrario si la dejas abierta tu respuesta será un SI. <br>
	Internamente lo que hace el juego es hacer peticiones a las urls de la aplicación pareadas con <a href="https://github.com/fourcoders/LatchBundle">LatchBundle</a> y convertir el permiso de autenticación en una respuesta.
</div>

<div id="game" class="hide">
	<div class="room pos0"></div>
	<div class="room pos1"></div>
	<div class="room pos2"></div>
	<div class="room pos3"></div>
	<div class="room pos4"></div>
	<div class="room pos5"></div>
	<div class="room pos6"></div>	
	<div id="player" data-pos="0">
		<div id="lifes">
			<div class="life"></div>
			<div class="life"></div>
			<div class="life"></div>
			<div class="life"></div>
			<div class="life"></div>
		</div>
	</div>
	<div id="questions">
		<div class="question green">
			<div class="circle"><i class="fa fa-question"></i></div>
			<p></p>
		</div>
		<div class="question red">
			<div class="circle"><i class="fa fa-question"></i></div>
			<p></p>
		</div>
		<div class="clear"></div>
		<div class="question blue">
			<div class="circle"><i class="fa fa-question"></i></div>
			<p></p>
		</div>
		<div class="question yellow">
			<div class="circle"><i class="fa fa-question"></i></div>
			<p></p>
		</div>
		<div class="clear"></div>
		<div id="check">COMPROBAR</div>
		<div id="open_help"><i class="fa fa-question"></i> Ayuda</div>

 	</div>
</div>

<script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
<script>
var time = 600;
$(function(){
	var lifes = 5;
	var aciertos = 0;
	var questions = {};
	var pos = 1;
	$("#start").click(function(){
		lifes = 5;
		aciertos = 0;
		questions = {};
		answers = {};	
		var i = 1;	
		$('#welcome').animate({opacity:0},time,function(){
			$(this).addClass('hide');
			$('#game').removeClass('hide').css({opacity:0}).animate({opacity:1},time);
		})
		$.post( "{{ path('fourcoders_questions') }}", function( data ) {
			$.each( data, function( color, val ) {
				questions[color] = val.result
				$('.question.'+color+' p').html(val.field)
			});
		});

	});

	$('#open_help').click(function(){
		$('#game').animate({opacity:0},time,function(){
			$(this).addClass('hide');
			$('#help').removeClass('hide').css({opacity:0}).animate({opacity:1},time);
		})
	})
	$('#close_help').click(function(){
		$('#help').animate({opacity:0},time,function(){
			$(this).addClass('hide');
			$('#game').removeClass('hide').css({opacity:0}).animate({opacity:1},time);
		})
	})
	// $("#start").click();
	/*
	var i = 1;
	$('#player').click(function(){
		$('#player').addClass('pos'+(i++))
	})
	$('#lifes').click(function(e){
		$('.life:first').remove();
		e.stopPropagation();
	})
	*/

	$('#check').click(function (e){
		var $this = $(this);
		if ($this.hasClass('disabled'))
			return false;
		$this.addClass('disabled').text('COMPROBANDO...');
		e.stopPropagation();
		var urls = [ "green" ,"red" ,"blue" , "yellow" ];
		var answers = {};
		var answersTotal = 0; 
		var answersNum = 4; 
		
		var checkTotal = function(){
			if (answersTotal == answersNum){
				$this.removeClass('disabled').text('COMPROBAR');

				evalua(answers)	

			}
		}
		$.each(urls, function( index, url) {
			console.log('Comprobando url /'+url)
			$.ajax({
			    url: '/'+url,
			    type: 'GET',
			    success: function(data){
			        console.log('Abierta 200 RESPONSE')
			        answers[url] = '1';
			        answersTotal++;
			        checkTotal();
			    },
			    error: function (x, status, error) {
			        if (x.status == 403) {
			        	console.log('Bloqueada 403 RESPONSE')
			        	answers[url] = '0';
				        answersTotal++;
				        checkTotal();
			        }
			    }
			});
		});
	});

	function evalua(answers){
		console.log(questions)
		console.log(answers)
		var fallo = 0
		$.each([ "green" ,"red" ,"blue" , "yellow" ], function(key, value) {
			if ( answers[value] != questions[value] ) {
				fallo = 1
			};
		});
		if (fallo == 0) {
			$('#player').attr('data-pos',pos++);
			aciertos++;
			flash(true,'Has acertado');
		} else {
			$('.life').not('.disabled').eq(-1).addClass('disabled')
			flash(false,'Has fallado');
			lifes--;
		}
		console.log('A Chema le quedan '+lifes+' vidas');
		if (lifes == 0) {
			$('#player').addClass('pos0')
			flash(false,'Has perdido')
			restart();
		} else {
			if (aciertos < 5) {
				$.post( "{{ path('fourcoders_questions') }}", function( data ) {
					$.each( data, function( color, val ) {
						questions[color] = val.result
						$('.question.'+color+' p').html(val.field)
					});
				});	
			} else {
				flash(true,'Chema esta fuera. Lo conseguimos.');

				restart();
			}
		}
	}



});

function restart(){
	$('#game').delay(2000).animate({opacity:0},time,function(){
		$(this).addClass('hide');
		$('.life').removeClass('disabled').removeAttr('style');
		$('#player').attr('data-pos',0);
		$('#welcome').removeClass('hide').css({opacity:0}).animate({opacity:1},time);
	})
}

	function flash(ok,str){
		$('.alert').addClass('hide')
		var $alert = $('#alert-'+(ok?'ok':'ko'));
		$alert.removeClass('hide').find('span').text(str);


	    $('#flash-message').removeClass('hide').removeAttr('style').delay(2000).animate({opacity:0,top:0},600,function(){
	        $(this).addClass('hide');
	    });
	}
</script>
</body>
</html>
